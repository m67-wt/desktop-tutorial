<!DOCTYPE html>
<html>
<head>
<style>
  body { margin: 0; overflow: hidden; background: black; }
  canvas { display: block; }
</style>
</head>
<body>

<canvas id="c"></canvas>

<script>
/* ================= CANVAS ================= */
const canvas = document.getElementById("c");
const ctx = canvas.getContext("2d");

function resize() {
  canvas.width = window.innerWidth;
  canvas.height = window.innerHeight;
  ctx.imageSmoothingEnabled = false;
}
window.addEventListener("resize", resize);
resize();

/* ================= MAP ================= */
const TILE = 64;
const map = [
  [4,4,4,4,4,4,4,4,4,4,4,4],
  [4,0,0,0,0,0,0,0,0,0,0,4],
  [4,0,1,1,1,0,2,2,0,0,0,4],
  [4,0,0,0,1,0,0,0,0,3,0,4],
  [4,0,3,0,1,0,4,0,0,3,0,4],
  [4,0,0,0,0,0,4,0,0,0,0,4],
  [4,4,4,4,4,4,4,4,4,4,4,4],
];

/* ================= TEXTURES ================= */
const TEXTURE_SIZE = 500;
function loadTexture(src) {
  const img = new Image();
  img.src = src;
  return img;
}

const wallTextures = [
  null,
  loadTexture("assets/wall textures-1.png"),
  loadTexture("assets/wall textures-2.png"),
  loadTexture("assets/wall textures-3.png"),
  loadTexture("assets/wall textures-4.png")
];

/* ================= PLAYER ================= */
const player = {
  x: TILE * 1.5,
  y: TILE * 1.5,
  angle: 0,
  move: 2,
  rot: 0.04
};

/* ================= WEAPON SPRITES ================= */
const idleImg = new Image();
idleImg.src = "assets/gun_idle.png";

const reloadSheet = new Image();
reloadSheet.src = "assets/gun_reload.png";

const weapon = {
  ammo: 25,
  maxAmmo: 25,
  state: "idle",

  // sprite animation
  frame: 0,
  frameTime: 0,
  fps: 30,

  frameWidth: 64,
  frameHeight: 64,
  reloadFrames: 19
};

/* ================= INPUT ================= */
const keys = {};
window.addEventListener("keydown", e => {
  keys[e.key.toLowerCase()] = true;
  if (e.key === "r") startReload();
});
window.addEventListener("keyup", e => keys[e.key.toLowerCase()] = false);
window.addEventListener("mousedown", shoot);

/* ================= WEAPON LOGIC ================= */
function shoot() {
  if (weapon.state !== "idle") return;
  if (weapon.ammo <= 0) return;
  weapon.ammo--;
}

function startReload() {
  if (weapon.state !== "idle") return;
  if (weapon.ammo === weapon.maxAmmo) return;

  weapon.state = "reload";
  weapon.frame = 0;
  weapon.frameTime = 0;
}

function updateWeapon(dt) {
  if (weapon.state === "reload") {
    weapon.frameTime += dt;

    if (weapon.frameTime > 1000 / weapon.fps) {
      weapon.frameTime = 0;
      weapon.frame++;

      if (weapon.frame >= weapon.reloadFrames) {
        weapon.state = "idle";
        weapon.ammo = weapon.maxAmmo;
        weapon.frame = 0;
      }
    }
  }
}

/* ================= ENGINE ================= */
function empty(x, y) {
  const mx = Math.floor(x / TILE);
  const my = Math.floor(y / TILE);
  return map[my] && map[my][mx] === 0;
}

function update(dt) {
  let nx = player.x, ny = player.y;
  if (keys["w"]) {
    nx += Math.cos(player.angle) * player.move;
    ny += Math.sin(player.angle) * player.move;
  }
  if (keys["s"]) {
    nx -= Math.cos(player.angle) * player.move;
    ny -= Math.sin(player.angle) * player.move;
  }
  if (keys["a"]) player.angle -= player.rot;
  if (keys["d"]) player.angle += player.rot;

  if (empty(nx, player.y)) player.x = nx;
  if (empty(player.x, ny)) player.y = ny;

  updateWeapon(dt);
}

/* ================= DRAWING ================= */
function drawWeapon() {
  const scale = 5;
  const w = weapon.frameWidth * scale;
  const h = weapon.frameHeight * scale;

  ctx.save();
  ctx.translate(canvas.width * 0.6, canvas.height - 40);
  ctx.rotate(-0.05);

  if (weapon.state === "reload") {
    ctx.drawImage(
      reloadSheet,
      weapon.frame * weapon.frameWidth,
      0,
      weapon.frameWidth,
      weapon.frameHeight,
      -w / 2,
      -h,
      w,
      h
    );
  } else {
    ctx.drawImage(idleImg, -w / 2, -h, w, h);
  }

  ctx.restore();
}

function drawUI() {
  ctx.fillStyle = "yellow";
  ctx.font = "bold 30px Arial";
  ctx.fillText("AMMO: " + weapon.ammo, 30, canvas.height - 30);

  ctx.strokeStyle = "lime";
  ctx.strokeRect(canvas.width/2-5, canvas.height/2-5, 10, 10);
}

/* ================= WALL RENDER ================= */
function drawWalls() {
  const fov = Math.PI / 3;

  for (let x = 0; x < canvas.width; x++) {
    const rayAngle = player.angle - fov/2 + (x/canvas.width)*fov;
    const rayCos = Math.cos(rayAngle);
    const raySin = Math.sin(rayAngle);

    let rx = player.x, ry = player.y;
    let dist = 0, wallId = 0, hitV = false;

    while (dist < 1000) {
      let px = rx;
      rx += rayCos * 2;
      ry += raySin * 2;
      dist += 2;

      const mx = Math.floor(rx / TILE);
      const my = Math.floor(ry / TILE);
      if (map[my] && map[my][mx] > 0) {
        wallId = map[my][mx];
        hitV = Math.floor(px / TILE) !== mx;
        break;
      }
    }

    if (!wallId) continue;

    const correctedDist = dist * Math.cos(rayAngle - player.angle);
    const wallHeight = (TILE * canvas.height) / correctedDist;
    const yPos = (canvas.height - wallHeight) / 2;

    const texture = wallTextures[wallId];
    if (texture && texture.complete) {
      ctx.drawImage(texture, 0, 0, 1, TEXTURE_SIZE, x, yPos, 1, wallHeight);
    }
  }
}

/* ================= MAIN LOOP ================= */
let last = performance.now();
function loop(now) {
  const dt = now - last;
  last = now;

  update(dt);

  ctx.fillStyle = "#222";
  ctx.fillRect(0, 0, canvas.width, canvas.height/2);
  ctx.fillStyle = "#444";
  ctx.fillRect(0, canvas.height/2, canvas.width, canvas.height/2);

  drawWalls();
  drawWeapon();
  drawUI();

  requestAnimationFrame(loop);
}
requestAnimationFrame(loop);
</script>

</body>
</html>
