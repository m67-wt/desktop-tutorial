<!DOCTYPE html>
<html>
<head>
    <style>
        body { margin: 0; overflow: hidden; background: black; }
        canvas { display: block; }
    </style>
</head>
<body>
<canvas id="c"></canvas>
<script>
const canvas = document.getElementById("c");
const ctx = canvas.getContext("2d");

function resize() {
    canvas.width = window.innerWidth;
    canvas.height = window.innerHeight;
    ctx.imageSmoothingEnabled = false;
}
window.addEventListener("resize", resize);
resize();

/* ================= WORLD ================= */
const TILE = 64;
const map = [
    [4,4,4,4,4,4,4,4,4,4,4,4],
    [4,0,0,0,0,0,0,0,0,0,0,4],
    [4,0,1,1,1,0,2,2,0,0,0,4],
    [4,0,0,0,1,0,0,0,0,3,0,4],
    [4,0,3,0,1,0,4,0,0,3,0,4],
    [4,0,0,0,0,0,4,0,0,0,0,4],
    [4,4,4,4,4,4,4,4,4,4,4,4],
];

/* ================= ASSETS ================= */
function loadImg(src) {
    const img = new Image();
    img.src = src;
    return img;
}

const wallTextures = [
    null,
    loadImg("assets/wall textures-1.png"),
    loadImg("assets/wall textures-2.png"),
    loadImg("assets/wall textures-3.png"),
    loadImg("assets/wall textures-4.png")
];

const weaponSheet = loadImg("assets/gun_reload.png");

/* ================= WEAPON CONFIG ================= */
const weapon = {
    ammo: 25,
    maxAmmo: 25,
    state: "idle",
    frame: 0,
    lastFrameUpdate: 0,
    animSpeed: 80 
};

// Map your 19 frames
const ANIMS = {
    idle: [0],
    fire: [1, 2, 3, 4, 5], 
    reload: [6, 7, 8, 9, 10, 11, 12, 13, 14, 15, 16, 17, 18]
};

const player = { x: TILE * 1.5, y: TILE * 1.5, angle: 0, move: 3, rot: 0.05 };
const keys = {};

window.addEventListener("keydown", e => {
    keys[e.key.toLowerCase()] = true;
    if (e.key === " ") shoot();
    if (e.key.toLowerCase() === "r") reload();
});
window.addEventListener("keyup", e => keys[e.key.toLowerCase()] = false);
window.addEventListener("mousedown", () => shoot());

/* ================= LOGIC ================= */
function shoot() {
    if (weapon.state !== "idle" || weapon.ammo <= 0) return;
    weapon.ammo--;
    weapon.state = "fire";
    weapon.frame = 0;
}

function reload() {
    if (weapon.state !== "idle" || weapon.ammo === weapon.maxAmmo) return;
    weapon.state = "reload";
    weapon.frame = 0;
}

function update() {
    let moveStep = 0;
    if (keys["w"]) moveStep = player.move;
    if (keys["s"]) moveStep = -player.move;
    if (keys["a"]) player.angle -= player.rot;
    if (keys["d"]) player.angle += player.rot;

    let nx = player.x + Math.cos(player.angle) * moveStep;
    let ny = player.y + Math.sin(player.angle) * moveStep;

    const isWall = (tx, ty) => map[Math.floor(ty/TILE)] && map[Math.floor(ty/TILE)][Math.floor(tx/TILE)] > 0;
    if (!isWall(nx, player.y)) player.x = nx;
    if (!isWall(player.x, ny)) player.y = ny;

    const now = performance.now();
    const currentAnim = ANIMS[weapon.state];
    if (now - weapon.lastFrameUpdate > weapon.animSpeed) {
        weapon.frame++;
        weapon.lastFrameUpdate = now;
        if (weapon.frame >= currentAnim.length) {
            if (weapon.state === "reload") weapon.ammo = weapon.maxAmmo;
            weapon.state = "idle";
            weapon.frame = 0;
        }
    }
}

/* ================= DRAWING ================= */
function drawUI() {
    // Crosshair
    ctx.strokeStyle = "lime";
    ctx.strokeRect(canvas.width/2-5, canvas.height/2-5, 10, 10);

    if (weaponSheet.complete && weaponSheet.width > 0) {
        // AUTO-DETECT FRAME WIDTH
        // If sheet is 1216px wide, 1216 / 19 = 64
        const frameW = weaponSheet.width / 19;
        const frameH = weaponSheet.height; 
        
        const currentAnim = ANIMS[weapon.state];
        const frameIdx = currentAnim[weapon.frame];

        // Scale gun to look good on any screen size
        const displayH = canvas.height * 0.7; 
        const displayW = displayH * (frameW / frameH);

        ctx.save();
        ctx.translate(canvas.width / 2, canvas.height);
        ctx.drawImage(
            weaponSheet,
            frameIdx * frameW, 0, frameW, frameH, // Source
            -displayW / 2, -displayH, displayW, displayH // Destination
        );
        ctx.restore();
    } else {
        // If image is still loading or broken
        ctx.fillStyle = "red";
        ctx.fillRect(canvas.width/2-25, canvas.height-50, 50, 50);
    }

    // Ammo HUD
    ctx.fillStyle = "yellow";
    ctx.font = "20px monospace";
    ctx.fillText("AMMO: " + weapon.ammo, 20, canvas.height - 20);
}

function drawWalls() {
    const fov = Math.PI / 3;
    for (let x = 0; x < canvas.width; x++) {
        const rayAngle = player.angle - fov/2 + (x/canvas.width)*fov;
        let rx = player.x, ry = player.y, dist = 0;
        while (dist < 800) {
            rx += Math.cos(rayAngle) * 2;
            ry += Math.sin(rayAngle) * 2;
            dist += 2;
            let mx = Math.floor(rx/TILE), my = Math.floor(ry/TILE);
            if (map[my] && map[my][mx] > 0) {
                let corrected = dist * Math.cos(rayAngle - player.angle);
                let h = (TILE * canvas.height) / corrected;
                ctx.fillStyle = "#555";
                ctx.fillRect(x, (canvas.height-h)/2, 1, h);
                break;
            }
        }
    }
}

function loop() {
    update();
    ctx.fillStyle = "#111"; ctx.fillRect(0,0,canvas.width, canvas.height/2);
    ctx.fillStyle = "#222"; ctx.fillRect(0,canvas.height/2,canvas.width, canvas.height/2);
    drawWalls();
    drawUI();
    requestAnimationFrame(loop);
}
loop();
</script>
</body>
</html>
