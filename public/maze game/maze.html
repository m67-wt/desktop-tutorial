<!DOCTYPE html>
<html>
<head>
    <title>Raycaster - Stable Build</title>
    <style>
        body { margin: 0; overflow: hidden; background: #000; color: white; }
        canvas { display: block; }
    </style>
</head>
<body>
<canvas id="c"></canvas>

<script>
const canvas = document.getElementById("c");
const ctx = canvas.getContext("2d");

function resize() {
    canvas.width = window.innerWidth;
    canvas.height = window.innerHeight;
}
window.addEventListener("resize", resize);
resize();

/* ================= ASSETS ================= */
// Using placeholders if your files aren't in the /assets folder yet
const GUN_IDLE = "assets/shotgun_idle.gif";
const GUN_FIRE = "assets/shotgun_fire.gif";
const GUN_RELOAD = "assets/shotgun_reload.gif";

const wallTextures = [null];
for(let i=1; i<=4; i++) {
    const img = new Image();
    img.src = `assets/wall textures-${i}.png`;
    wallTextures.push(img);
}

/* ================= GAME STATE ================= */
const TILE = 64;
const map = [
    [4,4,4,4,4,4,4,4,4,4,4,4],
    [4,0,0,0,0,0,0,0,0,0,0,4],
    [4,0,1,1,1,0,2,2,0,0,0,4],
    [4,0,0,0,0,0,0,0,0,0,0,4],
    [4,4,4,4,4,4,4,4,4,4,4,4]
];

const player = { x: 100, y: 100, angle: 0, move: 2, rot: 0.05 };
const weapon = { ammo: 25, max: 25, state: "idle", img: new Image() };
weapon.img.src = GUN_IDLE;

const keys = {};
window.addEventListener("keydown", e => {
    keys[e.key.toLowerCase()] = true;
    if (e.key === " " && weapon.state === "idle") shoot();
    if (e.key === "r" && weapon.state === "idle") reload();
});
window.addEventListener("keyup", e => keys[e.key.toLowerCase()] = false);

function shoot() {
    if (weapon.ammo <= 0) return;
    weapon.state = "firing";
    weapon.ammo--;
    weapon.img.src = GUN_FIRE + "?t=" + Date.now();
    setTimeout(() => { weapon.state = "idle"; weapon.img.src = GUN_IDLE; }, 500);
}

function reload() {
    weapon.state = "reloading";
    weapon.img.src = GUN_RELOAD + "?t=" + Date.now();
    setTimeout(() => { weapon.ammo = weapon.max; weapon.state = "idle"; weapon.img.src = GUN_IDLE; }, 1500);
}

/* ================= ENGINE ================= */
function update() {
    let nx = player.x + (keys["w"] ? Math.cos(player.angle)*2 : keys["s"] ? -Math.cos(player.angle)*2 : 0);
    let ny = player.y + (keys["w"] ? Math.sin(player.angle)*2 : keys["s"] ? -Math.sin(player.angle)*2 : 0);
    
    if (keys["a"]) player.angle -= player.rot;
    if (keys["d"]) player.angle += player.rot;

    // Simple Collision
    if (map[Math.floor(ny/TILE)][Math.floor(nx/TILE)] === 0) {
        player.x = nx; player.y = ny;
    }
}

function draw() {
    // Ceiling & Floor
    ctx.fillStyle = "#222"; ctx.fillRect(0,0,canvas.width, canvas.height/2);
    ctx.fillStyle = "#444"; ctx.fillRect(0,canvas.height/2,canvas.width, canvas.height/2);

    // Raycasting
    const fov = Math.PI/3;
    for(let i=0; i<canvas.width; i+=2) { // Step by 2 for performance
        let angle = (player.angle - fov/2) + (i/canvas.width) * fov;
        let dist = 0;
        let x = player.x, y = player.y;
        let cos = Math.cos(angle), sin = Math.sin(angle);

        while(dist < 600) {
            x += cos * 4; y += sin * 4; dist += 4;
            let mw = Math.floor(x/TILE), mh = Math.floor(y/TILE);
            if(map[mh] && map[mh][mw] > 0) {
                let h = (TILE * canvas.height) / (dist * Math.cos(angle-player.angle));
                ctx.fillStyle = `rgb(${200-(dist/3)},${200-(dist/3)},${200-(dist/3)})`;
                ctx.fillRect(i, (canvas.height-h)/2, 2, h);
                break;
            }
        }
    }

    // UI & Weapon
    drawUI();
}

function drawUI() {
    // Crosshair
    ctx.strokeStyle = "lime"; ctx.strokeRect(canvas.width/2-5, canvas.height/2-5, 10, 10);
    
    // Weapon (Safety check: only draw if image is loaded)
    if (weapon.img.complete) {
        let aspect = weapon.img.width / weapon.img.height;
        let h = canvas.height * 0.5;
        let w = h * aspect;
        ctx.drawImage(weapon.img, canvas.width/2 - w/2, canvas.height - h - 100, w, h);
    }

    // Wolfenstein Hotbar
    ctx.fillStyle = "#333"; ctx.fillRect(0, canvas.height-100, canvas.width, 100);
    ctx.strokeStyle = "#888"; ctx.lineWidth = 4; ctx.strokeRect(5, canvas.height-95, canvas.width-10, 90);
    
    ctx.fillStyle = "yellow"; ctx.font = "bold 40px monospace";
    ctx.fillText(`AMMO: ${weapon.ammo}`, 50, canvas.height-40);
    ctx.fillStyle = "white"; ctx.fillText("SHOTGUN", canvas.width-250, canvas.height-40);
}

function loop() {
    update();
    draw();
    requestAnimationFrame(loop);
}
loop();
</script>
</body>
</html>
